# FLOW — Комплексный аудит кодовой базы

**Дата:** 2025-07-14 (обновлён: 2025-07-15)  
**Стек:** Django 4.x + DRF · React 18 + TypeScript + MUI + Vite · PostgreSQL  
**Область:** Полный бэкенд (11 приложений, ~60 файлов) + полный фронтенд (16 страниц, ~25 файлов)  
**Всего проверено исходных файлов:** 85  
**Всего строк кода:** ~11 800

---

## Содержание

1. [Критические баги](#1-критические-баги)
2. [Проблемы безопасности](#2-проблемы-безопасности)
3. [Отсутствующий функционал](#3-отсутствующий-функционал)
4. [UX / Фронтенд проблемы](#4-ux--фронтенд-проблемы)
5. [Архитектурные проблемы бэкенда](#5-архитектурные-проблемы-бэкенда)
6. [Проблемы целостности данных](#6-проблемы-целостности-данных)
7. [Мультитенантность — детальный анализ](#7-мультитенантность--детальный-анализ)
8. [TypeScript / типизация](#8-typescript--типизация)
9. [Мёртвый и неиспользуемый код](#9-мёртвый-и-неиспользуемый-код)
10. [Специфичные для цветочного бизнеса пробелы](#10-специфичные-для-цветочного-бизнеса-пробелы)
11. [Приложение A — Инвентарь файлов бэкенда](#приложение-a--инвентарь-файлов-бэкенда)
12. [Приложение B — Инвентарь файлов фронтенда](#приложение-b--инвентарь-файлов-фронтенда)

---

## 1. Критические баги

### 1.1 Продажа не списывает товар со склада (FIFO не вызывается)

| Поле | Значение |
|------|----------|
| **Файл** | `backend/apps/sales/views.py` (SaleViewSet) |
| **Строки** | create/perform_create — отсутствует вызов `process_sale_items` |
| **Описание** | Сервисная функция `process_sale_items()` в `inventory/services.py` реализует FIFO-списание, расчёт себестоимости и создание `SaleItem`. Однако **ни один ViewSet её не вызывает**. `SaleViewSet.create()` сохраняет только шапку продажи. |
| **Влияние** | Продажа создаётся, остатки НЕ уменьшаются, себестоимость не считается, `SaleItem` не создаётся через сервис → финансовая отчётность и складской учёт полностью расходятся с реальностью. |
| **Исправление** | В `SaleViewSet.perform_create()` вызывать `process_sale_items(sale, items_data)` внутри `transaction.atomic()`. Принимать `items` из запроса (не read_only). |

### 1.2 SaleSerializer / OrderSerializer — items помечены как read_only

| Поле | Значение |
|------|----------|
| **Файл** | `backend/apps/sales/serializers.py` |
| **Строки** | `SaleSerializer`: `items = SaleItemSerializer(many=True, read_only=True)`; аналогично `OrderSerializer` |
| **Описание** | Фронтенд отправляет `items[]` в POST-запросе при создании продажи/заказа (SalesPage.tsx, OrdersPage.tsx), но сериализатор их **молча игнорирует** из-за `read_only=True`. |
| **Влияние** | Позиции, добавленные пользователем в форме, никогда не сохраняются. Продажа/заказ создаётся пустой. |
| **Исправление** | Убрать `read_only=True` у items; реализовать `create()`/`update()` в сериализаторе для вложенной записи, либо принимать items отдельным полем и обрабатывать во ViewSet. |

### 1.3 Баланс кошелька (`Wallet.balance`) не обновляется при создании транзакций

| Поле | Значение |
|------|----------|
| **Файл** | `backend/apps/finance/views.py` (TransactionViewSet) |
| **Описание** | При создании `Transaction` (доход/расход/перевод) поле `Wallet.balance` **никак не изменяется**. Нет ни сигнала, ни переопределения `perform_create`, ни сервисного слоя. |
| **Влияние** | Баланс всех кошельков статичен и показывает только начальное значение, введённое вручную. Финансовый учёт полностью нефункционален. |
| **Исправление** | Создать сервис `process_transaction()`, который в `atomic()` обновляет `wallet_from.balance -= amount`, `wallet_to.balance += amount` с проверкой `allow_negative`. |

### 1.4 Неверная себестоимость при сборке букета

| Поле | Значение |
|------|----------|
| **Файл** | `backend/apps/inventory/services.py`, функция `assemble_bouquet()` |
| **Строки** | ~330-410 |
| **Описание** | Себестоимость букета рассчитывается через `StockBalance.avg_purchase_price` **после** того, как компоненты уже списаны FIFO. К этому моменту `avg_purchase_price` в балансе может быть пересчитан или вообще обнулён (если баланс стал 0). |
| **Влияние** | Себестоимость букета рассчитывается неверно. |
| **Исправление** | Собирать фактическую себестоимость из данных FIFO-списания (цена каждой использованной партии × количество), а не из усреднённого баланса. |

### 1.5 Прямое CRUD-редактирование StockMovement обходит сервисный слой

| Поле | Значение |
|------|----------|
| **Файл** | `backend/apps/inventory/views.py` (StockMovementViewSet наследует ModelViewSet) |
| **Описание** | `StockMovementViewSet` — полный `ModelViewSet`, позволяющий создавать, редактировать и удалять движения напрямую через REST API, минуя FIFO-логику в `services.py`. |
| **Влияние** | Можно создать движение списания без реального уменьшения `StockBalance` и `Batch.remaining` → рассинхрон склада. |
| **Исправление** | Сделать `StockMovementViewSet` read-only (`ReadOnlyModelViewSet`). Все мутации — только через сервисные эндпоинты (`write-off`, `transfer`, etc.). |

---

## 2. Проблемы безопасности

### 2.1 Захардкоженный SECRET_KEY

| Поле | Значение |
|------|----------|
| **Файл** | `backend/config/settings.py` |
| **Строка** | `SECRET_KEY = os.environ.get('SECRET_KEY', 'django-insecure-k#8j1m#p1vx7...')` |
| **Влияние** | Если переменная окружения не задана, используется предсказуемый ключ → подделка JWT, сессий, CSRF-токенов. |
| **Исправление** | Убрать fallback; падать при отсутствии ENV-переменной. |

### 2.2 Захардкоженный пароль базы данных

| Поле | Значение |
|------|----------|
| **Файл** | `backend/config/settings.py` |
| **Строка** | `'PASSWORD': os.environ.get('DB_PASSWORD', 'RuSH.73501505wW')` |
| **Влияние** | Пароль БД доступен в репозитории. |
| **Исправление** | Вынести в `.env`, убрать fallback. |

### 2.3 DEBUG=True, ALLOWED_HOSTS=['*'], CORS_ALLOW_ALL_ORIGINS=True

| Поле | Значение |
|------|----------|
| **Файл** | `backend/config/settings.py` |
| **Описание** | Три флажка указывают на «production-unsafe»-конфигурацию: полные трейсбеки, нет проверки Host header, любой Origin принимается. |
| **Влияние** | XSS-рефлексия, CSRF-атаки из стороннего домена, утечка стектрейсов. |
| **Исправление** | `DEBUG = os.environ.get('DEBUG', 'False') == 'True'`; ALLOWED_HOSTS и CORS из ENV. |

### 2.4 JWT-токены хранятся в localStorage

| Поле | Значение |
|------|----------|
| **Файл** | `frontend/src/api.ts` |
| **Описание** | `localStorage.setItem('access', ...)` / `localStorage.setItem('refresh', ...)`. |
| **Влияние** | Уязвимость к XSS — любой injected-скрипт может украсть токены. |
| **Исправление** | Использовать httpOnly cookies для refresh-токена; access хранить в памяти. |

### 2.5 Отсутствие ролевых проверок (RBAC) на подавляющем большинстве ViewSet-ов

| Поле | Значение |
|------|----------|
| **Файл** | Все `views.py` кроме `core/views.py` (UserViewSet) |
| **Описание** | ViewSet-ы не задают `permission_classes`. DRF default — `IsAuthenticated` из `settings.py`. Классы `IsOwnerOrAdmin`, `IsManager`, `ReadOnlyOrManager` определены в `core/mixins.py`, но **нигде не применяются**, кроме `UserViewSet`. |
| **Влияние** | Любой аутентифицированный пользователь (включая `seller`, `courier`) может создавать/удалять зарплатные начисления, менять финансовые транзакции, удалять складские данные и т.д. |
| **Исправление** | На каждом ViewSet задать `permission_classes` в соответствии с ролевой моделью. |

### 2.6 MeasureUnit — нет tenant-изоляции

| Поле | Значение |
|------|----------|
| **Файл** | `backend/apps/nomenclature/models.py` (MeasureUnit), `backend/apps/nomenclature/views.py` (MeasureUnitViewSet) |
| **Описание** | Модель `MeasureUnit` не имеет поля `organization`. ViewSet не использует `OrgFilterMixin` и не фильтрует по организации. |
| **Влияние** | Все единицы измерения видны всем пользователям всех организаций (Cross-tenant data leak). |
| **Исправление** | Добавить FK `organization` в `MeasureUnit`; применить `OrgFilterMixin` во ViewSet; либо сделать их глобальными осознанно (read-only для не-суперюзеров). |

### 2.7 Отсутствие rate limiting

| Поле | Значение |
|------|----------|
| **Файл** | `backend/config/settings.py` |
| **Описание** | `DEFAULT_THROTTLE_CLASSES` и `DEFAULT_THROTTLE_RATES` не заданы. |
| **Влияние** | Brute-force на логин, DDoS через тяжёлые analytics-эндпоинты. |
| **Исправление** | Настроить `UserRateThrottle` / `AnonRateThrottle` в DRF settings. |

### 2.8 Слабая политика паролей

| Поле | Значение |
|------|----------|
| **Файл** | `backend/config/settings.py` |
| **Описание** | `AUTH_PASSWORD_VALIDATORS` содержит только `MinimumLengthValidator` (8 символов). Нет проверки на распространённые пароли, числовые пароли, сходство с username. |
| **Исправление** | Добавить `CommonPasswordValidator`, `NumericPasswordValidator`, `UserAttributeSimilarityValidator`. |

### 2.9 Отсутствие CSRF-защиты для API

| Поле | Значение |
|------|----------|
| **Файл** | `backend/config/settings.py` |
| **Описание** | При `CORS_ALLOW_ALL_ORIGINS = True` + JWT в localStorage, CSRF-защита фактически отключена. Если в будущем перейти на cookies, нужно будет задать `CSRF_TRUSTED_ORIGINS`. |

---

## 3. Отсутствующий функционал

### 3.1 Нет автоматической генерации DailySummary

| Поле | Значение |
|------|----------|
| **Файл** | `backend/apps/analytics/views.py`, `backend/apps/analytics/models.py` |
| **Описание** | `DailySummary` — только ручной CRUD через ViewSet. Нет Celery-задачи/management command, которая бы ежедневно агрегировала данные. Dashboard-эндпоинт делает live-запросы, но DailySummary заполняется только вручную. |
| **Влияние** | Аналитика пуста, если менеджер забудет вручную внести данные. |

### 3.2 Customer.total_purchases и purchases_count никогда не обновляются

| Поле | Значение |
|------|----------|
| **Файл** | `backend/apps/customers/models.py` |
| **Описание** | Поля `total_purchases`, `purchases_count`, `bonus_points` — чисто декларативные. Ни при создании Sale, ни при Order нет логики их инкремента. |
| **Влияние** | На карте клиента всегда `0 ₽ / 0 покупок / 0 бонусов`. |

### 3.3 PromoCode — нет валидации при использовании

| Поле | Значение |
|------|----------|
| **Файл** | `backend/apps/sales/views.py`, `backend/apps/marketing/models.py` |
| **Описание** | Модель `PromoCode` имеет `max_uses`, `used_count`, `start_date`, `end_date`. Но при создании заказа с `promo_code` нет проверки лимитов и дат; `used_count` не инкрементируется. |
| **Влияние** | Промокод можно использовать бесконечно, даже после истечения срока. |

### 3.4 Нет автоматической генерации номера заказа/продажи

| Поле | Значение |
|------|----------|
| **Файл** | `backend/apps/sales/models.py` |
| **Описание** | У `Sale` и `Order` есть поле `number` (CharField), но нет логики автогенерации. Пользователь должен заполнить его вручную; фронтенд это поле даже не показывает при создании. |
| **Влияние** | Номера пустые или дублируются. |

### 3.5 Нет финансовой транзакции при создании продажи

| Поле | Значение |
|------|----------|
| **Описание** | При завершении продажи (status=completed) не создаётся `Transaction` (доход) и не обновляется Wallet. Связка «Продажа → Финансы» отсутствует полностью. |

### 3.6 Заказ поставщику не создаёт приход на склад

| Поле | Значение |
|------|----------|
| **Файл** | `backend/apps/suppliers/views.py` |
| **Описание** | При смене статуса заказа поставщику на `delivered` не создаётся `Batch` / `StockMovement` — приход товара на склад требует ручного ввода. |

### 3.7 Нет автоматической скидки для клиента/группы клиентов

| Поле | Значение |
|------|----------|
| **Описание** | `Customer.discount_percent` и `CustomerGroup.discount_percent` никак не применяются при создании продажи/заказа. Скидку нужно вводить вручную для каждой позиции. |

### 3.8 Программы лояльности — только CRUD, без логики

| Поле | Значение |
|------|----------|
| **Файл** | `backend/apps/marketing/models.py` (LoyaltyProgram) |
| **Описание** | `LoyaltyProgram` имеет `accrual_percent` и `max_payment_percent`, но нигде нет логики начисления/списания бонусов при продаже. |

### 3.9 Нет напоминаний о важных датах клиентов

| Поле | Значение |
|------|----------|
| **Файл** | `backend/apps/customers/models.py` (ImportantDate) |
| **Описание** | `ImportantDate` имеет `remind_days_before`, но нет задачи/механизма отправки напоминаний (email/push/уведомление в системе). |

### 3.10 Отсутствие API-версионирования

| Поле | Значение |
|------|----------|
| **Файл** | `backend/config/urls.py` |
| **Описание** | API доступен по `/api/core/`, `/api/sales/` и т.д. без версии (`/api/v1/...`). |
| **Влияние** | Невозможно обновлять API без ломающих изменений для клиентов. |

### 3.11 Нет отслеживания срока годности (expiry alerts)

| Поле | Значение |
|------|----------|
| **Файл** | `backend/apps/inventory/models.py` (Batch.expiry_date) |
| **Описание** | Партии имеют `expiry_date`, но нет механизма предупреждения о скорой просрочке или автоматического списания просроченных остатков. Для цветочного бизнеса это критично (срок жизни цветов 3-7 дней). |

### 3.12 Нет пагинации с серверной стороны на большинстве фронтенд-страниц

| Поле | Значение |
|------|----------|
| **Файл** | Все страницы кроме `OrdersPage.tsx` и `SalesPage.tsx` |
| **Описание** | Большинство страниц загружает все записи одним запросом (`r.data.results || r.data || []`). Серверная пагинация (`PAGE_SIZE=25`) настроена в DRF, но фронтенд не передаёт `page` параметр. |

---

## 4. UX / Фронтенд проблемы

### 4.1 Позиции продажи не сохраняются (фронтенд отправляет, бэкенд игнорирует)

| Поле | Значение |
|------|----------|
| **Файл** | `frontend/src/pages/SalesPage.tsx` |
| **Описание** | Пользователь добавляет позиции в диалоге создания продажи, но бэкенд их игнорирует (см. баг 1.2). Пользователь не получает ошибки — продажа создаётся «пустой». |
| **Влияние** | Критическое нарушение UX: пользователь считает, что всё сохранено, а позиций нет. |

### 4.2 Нет редактирования позиций заказа после создания

| Поле | Значение |
|------|----------|
| **Файл** | `frontend/src/pages/OrdersPage.tsx` |
| **Описание** | В детальном диалоге заказа (`detailDlg`) позиции показываются только для чтения. Нет кнопки/механизма добавить/удалить/изменить позицию существующего заказа. |

### 4.3 Удалённые данные не запрашивают причину / не делают soft-delete

| Поле | Значение |
|------|----------|
| **Файл** | Все frontend-страницы |
| **Описание** | Удаление (партий, движений, продаж, сотрудников и т.д.) — жёсткое (`api.delete`). Нет soft-delete, нет журнала действий, нет возможности восстановления. |
| **Влияние** | Случайное удаление продажи/заказа необратимо; нет audit trail. |

### 4.4 Нет валидации формы доставки — Order.id вводится текстом

| Поле | Значение |
|------|----------|
| **Файл** | `frontend/src/pages/DeliveryPage.tsx` |
| **Строка** | `<TextField fullWidth label="Заказ" size="small" value={delForm.order} ...>` |
| **Описание** | Поле «Заказ» в форме доставки — обычное текстовое поле, куда нужно вставить UUID заказа. Нет выпадающего списка заказов. |
| **Влияние** | Пользователь должен копировать UUID вручную, что практически невозможно. |

### 4.5 Шаблон букета: компоненты удаляются и пересоздаются при каждом сохранении

| Поле | Значение |
|------|----------|
| **Файл** | `frontend/src/pages/NomenclaturePage.tsx`, функция `saveTpl` |
| **Описание** | При редактировании шаблона все старые компоненты удаляются через `Promise.all(map(delete))`, затем создаются заново через `Promise.all(map(post))`. Это не атомарно. |
| **Влияние** | Если один из запросов упадёт, шаблон останется с частично удалёнными/созданными компонентами. |
| **Исправление** | Реализовать bulk-update на бэкенде (один PUT-запрос для шаблона + компоненты). |

### 4.6 Нет индикации обязательных полей в формах

| Поле | Значение |
|------|----------|
| **Файл** | Множество `EntityFormDialog` по всему фронтенду |
| **Описание** | Во многих формах (DeliveryPage, MarketingPage, FinancePage) отсутствует `required` attribute на полях, хотя бэкенд их требует. Пользователь узнаёт об ошибке только после попытки сохранения. |

### 4.7 Нет перехода между связанными сущностями

| Поле | Значение |
|------|----------|
| **Описание** | Нет навигации: из карточки клиента нельзя перейти к его заказам/продажам; из заказа нельзя перейти к доставке; из продажи нельзя перейти к финансовой операции. Все разделы изолированы. |

### 4.8 DashboardPage — показывает «Низкие остатки» без порога и без ссылки

| Поле | Значение |
|------|----------|
| **Файл** | `frontend/src/pages/DashboardPage.tsx` |
| **Описание** | Запрос к `stock-balances` не фильтрует по минимальным остаткам — показывает просто первые N записей отсортированных по количеству. Нет сравнения с `Nomenclature.min_stock`. |

### 4.9 AnalyticsPage — DailySummary вручную, но в UI нет формы создания

| Поле | Значение |
|------|----------|
| **Файл** | `frontend/src/pages/AnalyticsPage.tsx` |
| **Описание** | На странице аналитики только графики и таблица — нет кнопки «Создать сводку» или «Сгенерировать». При пустой таблице пользователь не может понять, как её наполнить. |

---

## 5. Архитектурные проблемы бэкенда

### 5.1 Бизнес-логика размазана между ViewSet и сервисами

| Поле | Значение |
|------|----------|
| **Описание** | `inventory/services.py` реализует сложную бизнес-логику (FIFO, сборка, трансфер), но `sales/views.py`, `finance/views.py`, `suppliers/views.py` работают как простой CRUD без сервисного слоя. В итоге: (a) inventory-сервисы не вызываются, (b) нет единой точки входа для бизнес-операций. |
| **Исправление** | Создать сервисный слой для каждого модуля: `sales/services.py`, `finance/services.py`, `suppliers/services.py`. ViewSet-ы должны только делегировать. |

### 5.2 `fields = '__all__'` на всех сериализаторах

| Поле | Значение |
|------|----------|
| **Файл** | Все `serializers.py` |
| **Описание** | Каждый сериализатор использует `fields = '__all__'`. Это экспонирует все поля модели, включая служебные (`id`, `organization`, временные метки). |
| **Влияние** | Утечка внутренних полей; при добавлении нового поля в модель оно автоматически попадает в API без ревью. |
| **Исправление** | Явно перечислить `fields = [...]` для каждого сериализатора. |

### 5.3 Нет логирования и audit trail

| Поле | Значение |
|------|----------|
| **Описание** | Нет `django-auditlog`, `django-simple-history` или аналога. Ни одно действие (создание/изменение/удаление) не логируется. Для финансового/складского ПО это критично. |

### 5.4 UUID primary keys без индекса поиска по «human-readable» номеру

| Поле | Значение |
|------|----------|
| **Файл** | Все модели наследуют `BaseModel` с `id = UUIDField(primary_key=True)` |
| **Описание** | UUID хорош для распределённости, но нет числового auto-increment номера, по которому пользователь может искать «Заказ №1234». Поля `number` (CharField) не имеют `unique=True` и не автогенерируются. |

### 5.5 N+1 проблемы на нескольких ViewSet

| Поле | Значение |
|------|----------|
| **Файл** | `backend/apps/finance/views.py`, `backend/apps/delivery/views.py` |
| **Описание** | `TransactionViewSet` и `DeliveryViewSet` не используют `select_related`/`prefetch_related`, хотя сериализаторы обращаются к связанным объектам (`category_name`, `wallet_from_name`, `courier_name`). |
| **Влияние** | По запросу на каждую строку при отображении списка. |

### 5.6 Отсутствие тестов

| Поле | Значение |
|------|----------|
| **Описание** | Ни одного unit/integration теста не обнаружено в кодовой базе. Для финансового и складского ПО это критический gap. |

### 5.7 Нет Celery / фоновых задач

| Поле | Значение |
|------|----------|
| **Описание** | Нет infrastructure для асинхронных задач: нет Celery, нет Django-Q, нет cron-management commands. Необходимо для: генерации DailySummary, уведомлений о просрочке, напоминаний о датах клиентов, периодического пересчёта балансов. |

### 5.8 Один файл на страницу (god-components)

| Поле | Значение |
|------|----------|
| **Файл** | Все `frontend/src/pages/*.tsx` (от 322 до 760 строк каждый) |
| **Описание** | Каждая страница — монолитный компонент с 5-10 `useState`, 3-5 `useCallback`, несколькими диалогами и всей логикой в одном файле. |
| **Влияние** | Трудно поддерживать, тестировать и переиспользовать. |
| **Исправление** | Разбить на sub-компоненты и custom hooks (`useWallets`, `useTransactions`, etc.). |

---

## 6. Проблемы целостности данных

### 6.1 Batch — прямое редактирование `remaining` без пересчёта StockBalance

| Поле | Значение |
|------|----------|
| **Файл** | `backend/apps/inventory/views.py` (BatchViewSet — полный ModelViewSet) |
| **Описание** | InventoryPage.tsx позволяет редактировать партию (включая `remaining`). BatchViewSet — ModelViewSet, позволяющий PATCH/PUT. Изменение `remaining` не пересчитывает `StockBalance.quantity` и `avg_purchase_price`. |
| **Влияние** | `StockBalance` рассинхронизируется с суммой `Batch.remaining`. |
| **Исправление** | Запретить прямое редактирование `remaining`; разрешить редактирование только метаданных (invoice_number, notes, expiry_date). |

### 6.2 Удаление Batch/StockMovement не корректирует StockBalance

| Поле | Значение |
|------|----------|
| **Файл** | `backend/apps/inventory/views.py` |
| **Описание** | DELETE на Batch или StockMovement через API не вызывает пересчёт `StockBalance`. |
| **Влияние** | Удаление партии с `remaining=50` не уменьшает StockBalance.quantity → виртуальный «лишний» товар на складе. |

### 6.3 `_update_stock_balance` — clamp к 0 вместо ошибки

| Поле | Значение |
|------|----------|
| **Файл** | `backend/apps/inventory/services.py`, функция `_update_stock_balance()` |
| **Описание** | `new_quantity = max(Decimal('0'), balance.quantity - quantity)` — если остаток уходит в минус, он молча обрезается до 0, вместо того чтобы выбросить исключение. |
| **Влияние** | Маскирование ошибок учёта; невозможно отследить, когда списали больше, чем было. |

### 6.4 Нет unique_together на Sale.number и Order.number

| Поле | Значение |
|------|----------|
| **Файл** | `backend/apps/sales/models.py` |
| **Описание** | `number = models.CharField(max_length=50, blank=True)` — нет `unique=True` внутри организации. |
| **Влияние** | Дубликаты номеров; невозможно однозначно найти «Заказ №1001». |
| **Исправление** | Добавить `unique_together = ['organization', 'number']` или генерировать автоматически. |

### 6.5 Delivery — OneToOneField с Order, но нет валидации

| Поле | Значение |
|------|----------|
| **Файл** | `backend/apps/delivery/models.py` |
| **Описание** | `Delivery.order = OneToOneField(Order, null=True)`. При создании Delivery через фронтенд поле order — текстовый ввод UUID (см. UX баг 4.4). Нет проверки, что заказ существует и принадлежит той же организации. |
| **Влияние** | Можно привязать доставку к несуществующему заказу или заказу чужой организации. |

### 6.6 Нет каскадной защиты на удаление ключевых сущностей

| Поле | Значение |
|------|----------|
| **Файл** | Все модели |
| **Описание** | Большинство FK используют `on_delete=models.CASCADE`. Удаление `TradingPoint` каскадно удалит все связанные склады, продажи, заказы, смены. Удаление `Nomenclature` удалит все партии, движения, позиции продаж. |
| **Влияние** | Одно случайное удаление может уничтожить массив данных. |
| **Исправление** | Использовать `on_delete=models.PROTECT` для критических FK или реализовать soft-delete. |

### 6.7 `Sale.total` и `Order.total` — хранятся, но не пересчитываются

| Поле | Значение |
|------|----------|
| **Файл** | `backend/apps/sales/models.py` |
| **Описание** | `total = DecimalField(default=0)` — статическое поле. При добавлении/удалении/изменении `SaleItem` через бэкенд поле `total` не пересчитывается. |
| **Влияние** | Рассинхрон между суммой позиций и итогом в шапке. |

### 6.8 InventoryDocument / InventoryItem — CRUD без логики инвентаризации

| Поле | Значение |
|------|----------|
| **Файл** | `backend/apps/inventory/models.py`, `backend/apps/inventory/views.py` |
| **Описание** | Модели `InventoryDocument` и `InventoryItem` (документ инвентаризации) существуют, но: (a) нет ViewSet-а для них, (b) нет логики сравнения фактического и учётного остатка, (c) нет создания корректирующих движений. |

---

## Сводка по приоритетам

| Приоритет | Количество | Примеры |
|-----------|-----------|---------|
| **P0 — Блокер** | 5 | 1.1, 1.2, 1.3, 2.1, 2.2 |
| **P1 — Критичный** | 10 | 1.4, 1.5, 2.3-2.6, 3.1, 3.2, 6.1-6.3 |
| **P2 — Важный** | 12 | 2.7-2.9, 3.3-3.8, 4.1, 4.2, 5.1-5.3 |
| **P3 — Улучшение** | 10 | 3.9-3.12, 4.3-4.9, 5.4-5.8 |
| **Итого** | **37** | |

---

## Рекомендуемый порядок исправления

1. **Безопасность (P0):** Убрать захардкоженные секреты, настроить DEBUG/CORS/ALLOWED_HOSTS через env
2. **Ядро продаж (P0):** Реализовать полный цикл Sale: прием items → FIFO-списание → создание Transaction → обновление Wallet.balance → обновление Customer статистики
3. **RBAC (P1):** Применить permission_classes на все ViewSet-ы
4. **Защита данных (P1):** Запретить прямой CRUD на StockMovement/Batch.remaining, добавить PROTECT/soft-delete
5. **Сервисный слой (P2):** Создать services.py для sales, finance, suppliers
6. **Автоматизация (P2):** Celery + задачи для DailySummary, expiry alerts, напоминаний
7. **Фронтенд/UX (P3):** Разбить god-components, добавить серверную пагинацию, связи между разделами

---

## 7. Мультитенантность — детальный анализ

### 7.1 Модели без поля organization (cross-tenant exposure)

| Модель | Файл | Проблема |
|--------|------|----------|
| `MeasureUnit` | `nomenclature/models.py` | Нет FK `organization`. Единицы измерения глобальны — все тенанты видят и могут менять чужие единицы. |

### 7.2 ViewSet-ы без tenant-фильтрации

| ViewSet | Файл | Проблема |
|---------|------|----------|
| `MeasureUnitViewSet` | `nomenclature/views.py` | Не использует `_tenant_filter()`. Queryset возвращает все записи без фильтра по организации. |

### 7.3 Неправильный резолв организации

| Место | Файл | Проблема |
|-------|------|----------|
| `DailySummaryViewSet.dashboard()` | `analytics/views.py` | Использует `request.user.organization` напрямую вместо `_resolve_org(request.user)`. Для суперадминов с `active_organization` данные подтянутся не из той организации (или вернут `None`). |

### 7.4 Нет проверки организации при cross-model операциях

| Операция | Пример | Проблема |
|----------|--------|----------|
| Создание Delivery | `delivery/views.py` | Пользователь может указать `order` из чужой организации (проверка не делается). |
| SaleItem → Batch | `inventory/services.py` | FIFO берёт партии из фильтра `warehouse__organization`, но theoretically user can pass wrong warehouse_id. |
| SupplierNomenclature | `suppliers/views.py` | Можно привязать номенклатуру одного тенанта к поставщику другого (нет cross-FK validation). |

### 7.5 Нет enforcement бизнес-ограничений тарифного плана

| Ограничение | Модель | Проблема |
|-------------|--------|----------|
| `max_users` | `Organization` | Поле существует, но при создании нового пользователя нет проверки лимита. |
| `subscription_plan` | `Organization` | Нет middleware/mixin, который блокирует API при просроченном `paid_until`. |
| `is_active` | `Organization` | Нет проверки — деактивированная организация продолжает иметь доступ к API. |

---

## 8. TypeScript / типизация

### 8.1 Повсеместное использование `Record<string, any>`

| Файл | Кол-во вхождений | Описание |
|------|-------------------|----------|
| `SalesPage.tsx` | 3 | Payload продажи типизирован как `Record<string, any>` вместо строгого интерфейса. |
| `OrdersPage.tsx` | 1 | Аналогично для payload заказа. |
| `SuppliersPage.tsx` | 4 | Payload для поставщика, заказа, номенклатуры, претензии. |
| `StaffPage.tsx` | 4 | Payload для сотрудника, должности, смены, начисления. |
| `FinancePage.tsx` | 4 | Payload для кошелька, транзакции, категории, долга. |
| `MarketingPage.tsx` | 2 | Payload для скидки, промокода. |
| `DeliveryPage.tsx` | 3 | Payload для доставки, курьера, зоны. |
| `CustomersPage.tsx` | 4 | Payload для клиента, даты, адреса, группы. |
| **Итого** | **~25** | Потеря type safety при формировании запросов к API. |

**Влияние:** Ошибки в именах полей, пропущенные обязательные поля и неправильные типы значений не отлавливаются компилятором.  
**Исправление:** Создать строгие TS-интерфейсы для каждого API payload (`CreateSalePayload`, `UpdateOrderPayload`, etc.).

### 8.2 Render-функции в колонках DataTable принимают `any`

| Пример | Файл |
|--------|------|
| `render: (_: any, row: Customer) => ...` | CustomersPage, SalesPage, StaffPage, и все остальные |
| `render: (v: string) => ...` (но реальный тип может быть `number | null`) | FinancePage (amount), AnalyticsPage |

**Описание:** Первый аргумент render (`value`) часто типизирован как `any` или неверный примитив. DataTable не является дженериком — колонки не параметризованы типом строки.

**Исправление:** Сделать `DataTable` дженериком: `DataTable<T>`, колонки: `Column<T>`, render: `(value: T[K], row: T) => ReactNode`.

### 8.3 Отсутствие strict mode в tsconfig

| Файл | Проблема |
|------|----------|
| `tsconfig.json` | Нужно проверить наличие `"strict": true`. Без strict mode: неявный `any`, отсутствие null-checks, необязательность return type. |

### 8.4 Не типизированы ответы API

| Файл | Проблема |
|------|----------|
| `api.ts` | `api.get('/sales/orders/')` возвращает `AxiosResponse<any>`. Типы ответов нигде не параметризованы. |
| Все страницы | `res.data.results || res.data || []` — паттерн повторяется ~40 раз. Нет типизированной обёртки `PaginatedResponse<T>`. |

**Исправление:** Создать функцию-обёртку:
```ts
async function fetchPaginated<T>(url: string, params?: object): Promise<T[]> {
  const res = await api.get<PaginatedResponse<T>>(url, { params });
  return res.data.results ?? res.data ?? [];
}
```

### 8.5 Множественный `useState` вместо `useReducer`

| Файл | Кол-во useState | Описание |
|------|-----------------|----------|
| `SuppliersPage.tsx` | ~40 | 4 вкладки × (data + loading + dialog + edit + form + saving + del) |
| `StaffPage.tsx` | ~36 | 4 вкладки × аналогичный набор |
| `FinancePage.tsx` | ~32 | 4 вкладки |
| `MarketingPage.tsx` | ~35 | 5 вкладок |

**Влияние:** Не ошибка TypeScript как таковая, но делает состояние трудноуправляемым и повышает вероятность багов рассинхрона состояния.

---

## 9. Мёртвый и неиспользуемый код

### 9.1 Модель `PayrollScheme` — нет API, нет фронтенда

| Файл | Строки | Описание |
|------|--------|----------|
| `staff/models.py` | L97-125 | Модель `PayrollScheme` (fixed/hourly/shift/percent_sales/mixed) определена, но: нет сериализатора, нет ViewSet-а, нет URL-маршрута, нет фронтенд-страницы. Полностью мёртвый код. |

### 9.2 `InventoryDocumentViewSet` — зарегистрирован, но недоступен с фронтенда

| Файл | Описание |
|------|----------|
| `inventory/views.py`, `inventory/urls.py` | ViewSet зарегистрирован по маршруту `inventory-docs/`, но InventoryPage.tsx не содержит вкладки для инвентаризаций. Модель `InventoryItem` также не используется. |

### 9.3 `ReserveViewSet` — зарегистрирован, но не используется фронтендом

| Файл | Описание |
|------|----------|
| `inventory/views.py`, `inventory/urls.py` | Маршрут `reserves/` зарегистрирован. Модель `Reserve` (резервирование товара под заказ) определена, но нигде не вызывается — ни при создании заказа, ни на фронтенде. |

### 9.4 Переменная `discountName` в MarketingPage

| Файл | Строка | Описание |
|------|--------|----------|
| `MarketingPage.tsx` | ~460 | Функция `discountName(id)` определена для маппинга ID скидки → название. Используется только в tab промокодов для колонки `discount`. Сама по себе не мёртвая, но может быть упрощена inline. |

### 9.5 `incomeTypes` / `expenseTypes` в FinancePage

| Файл | Строки | Описание |
|------|--------|----------|
| `FinancePage.tsx` | L70-71 | `Set`-ы для определения направления транзакции. Используются, но дублируют информацию из `TRANSACTION_TYPES` — можно вычислять из одного источника. |

### 9.6 Неиспользуемые импорты иконок

| Файл | Импорт | Описание |
|------|--------|----------|
| `OrdersPage.tsx` | `ShoppingBag` | Импортирован, используется только в `statusIcon()` fallback (default case). |
| `SettingsPage.tsx` | `VpnKey` | Импортирован, но нигде не используется в JSX. |
| `SuppliersPage.tsx` | `Star` | Импортирован, но не используется (рейтинг отображается через MUI `Rating`). |

### 9.7 Django admin registrations — минимальны и не настроены

| Файл | Описание |
|------|----------|
| Все `admin.py` (11 файлов) | Содержат только `admin.site.register(Model)` без `list_display`, `list_filter`, `search_fields`. Admin-панель фактически бесполезна для оперативной работы — все записи показываются как `__str__`. |

### 9.8 `__pycache__` и `migrations` не в .gitignore?

| Описание |
|----------|
| В структуре проекта видны `__pycache__/` директории. Следует убедиться, что они в `.gitignore`. |

---

## 10. Специфичные для цветочного бизнеса пробелы

### 10.1 Нет фото товаров / букетов

| Описание |
|----------|
| Модель `Nomenclature` не имеет поля для изображения (ни `ImageField`, ни URL). Для цветочного магазина каталог без фотографий — критический пробел. Клиенты и флористы не видят внешний вид букетов. |

### 10.2 Нет атрибутов цветов (цвет, высота стебля, размер бутона)

| Описание |
|----------|
| `Nomenclature` хранит тип (`single_flower`), цену и shelf_life, но нет специфических атрибутов: цвет лепестков, высота стебля (см), размер бутона, аромат. Это необходимо для фильтрации при составлении букетов. |

### 10.3 Нет отслеживания свежести / срока годности партий цветов

| Описание |
|----------|
| `Batch.expiry_date` существует, но: (a) не обязателен, (b) нет автоматического предупреждения при приближении срока, (c) нет автоматического списания просроченных, (d) нет визуального индикатора «осталось N дней» на складской странице. Для цветов со сроком жизни 3-7 дней это критично. |

### 10.4 Нет интеграции с мессенджерами

| Описание |
|----------|
| Заказы имеют источники `telegram`, `whatsapp`, `instagram`, но нет реальной интеграции — бот-приём заказов, отправка статусов клиенту, уведомления курьеру. |

### 10.5 Нет каталога / витрины для клиентов

| Описание |
|----------|
| Система — только внутренний бэк-офис. Нет public-facing каталога букетов для клиентов, нет корзины, нет онлайн-заказа. Для SaaS цветочного магазина это must-have функционал. |

### 10.6 Нет расчёта стоимости авторского букета

| Описание |
|----------|
| `SaleItem.is_custom_bouquet` и `custom_description` — только флаг и текст. Нет механизма подбора компонентов и расчёта цены «на лету» для авторского букета от флориста. |

### 10.7 Нет учёта температурного режима и условий хранения

| Описание |
|----------|
| Склады имеют тип `fridge` (холодильник), но нет привязки номенклатуры к требуемым условиям хранения (мин/макс температура, влажность). Нет контроля, что тропические цветы не помещены в холодильник. |

### 10.8 Нет сезонного ценообразования

| Описание |
|----------|
| `Nomenclature` имеет поля `season_start` / `season_end`, но нет логики автоматического изменения цены в зависимости от сезона (например, розы перед 8 марта). |

### 10.9 Нет SMS/email уведомлений клиенту о статусе заказа

| Описание |
|----------|
| При изменении статуса заказа (собран, в доставке, доставлен) клиент не получает уведомления. Для цветочной доставки — стандартный функционал. |

### 10.10 Нет функционала «повторный заказ»

| Описание |
|----------|
| Нет возможности быстро создать повторный заказ на основе предыдущего (тот же состав, тот же адрес). Для регулярных клиентов (подписка на цветы) — важный UX. |

---

## Приложение A — Инвентарь файлов бэкенда

### config/

| Файл | Строк | Описание | Проблемы |
|------|-------|----------|----------|
| `config/settings.py` | 143 | Django settings: PostgreSQL, SimpleJWT (12h/7d), CORS, Auth | **P0:** Хардкод пароля БД, DEBUG=True, ALLOWED_HOSTS=\*, CORS=\*, слабый SECRET_KEY fallback, только MinimumLengthValidator |
| `config/urls.py` | 34 | Роутинг: JWT auth + 11 app prefixes (/api/core/, /api/sales/, ...) | Нет API-версионирования (/api/v1/) |
| `config/asgi.py` | — | Стандартный ASGI | — |
| `config/wsgi.py` | — | Стандартный WSGI | — |

### apps/core/

| Файл | Строк | Описание | Проблемы |
|------|-------|----------|----------|
| `core/models.py` | 168 | Organization (UUID PK, subscription, billing), User (extends AbstractUser, role, org FK, active_org FK), TradingPoint, Warehouse (5 типов), PaymentMethod | on_delete=CASCADE на критических FK |
| `core/mixins.py` | 101 | Permission classes (IsPlatformAdmin, IsOwnerOrAdmin, IsManager, ReadOnlyOrManager), `_resolve_org()`, `_tenant_filter()`, OrgPerformCreateMixin | Классы определены, но **не применяются** в 90% ViewSet-ов |
| `core/views.py` | 173 | 5 ViewSets: Organization, User (me, change_password, set_password, set_active_org), TradingPoint, Warehouse, PaymentMethod | `set_password` не проверяет роль вызывающего (owner/admin) |
| `core/serializers.py` | 87 | 7 сериализаторов, `fields='__all__'` повсюду | Expose всех полей, включая служебные |
| `core/urls.py` | 14 | Router с 5 маршрутами | — |
| `core/admin.py` | 27 | `admin.site.register()` для 5 моделей | Нет list_display/search_fields |

### apps/analytics/

| Файл | Строк | Описание | Проблемы |
|------|-------|----------|----------|
| `analytics/models.py` | 40 | DailySummary: per trading_point per date (revenue, cost, profit, sales_count, orders_count, avg_check, new_customers, write_offs) | Нет автогенерации — только ручной CRUD |
| `analytics/views.py` | 63 | DailySummaryViewSet + `dashboard` action (today/month revenue, active orders, total customers) | **Bug:** `dashboard` использует `request.user.organization` вместо `_resolve_org()` |
| `analytics/serializers.py` | 14 | DailySummarySerializer (`fields='__all__'`) | — |
| `analytics/urls.py` | 10 | Маршрут `daily-summary/` | — |

### apps/customers/

| Файл | Строк | Описание | Проблемы |
|------|-------|----------|----------|
| `customers/models.py` | 116 | CustomerGroup, Customer (gender, birth_date, bonus_points, total_purchases, groups M2M, `@property full_name`), ImportantDate (remind_days_before), CustomerAddress | `total_purchases`, `purchases_count`, `bonus_points` никогда не обновляются |
| `customers/views.py` | 62 | 4 ViewSets: CustomerGroup, Customer (search, filter), ImportantDate, CustomerAddress | Нет permission_classes (любой аутент. юзер = полный доступ) |
| `customers/serializers.py` | 47 | Nested important_dates & addresses в detail, light CustomerListSerializer | — |
| `customers/urls.py` | 12 | 4 маршрута | — |

### apps/delivery/

| Файл | Строк | Описание | Проблемы |
|------|-------|----------|----------|
| `delivery/models.py` | 121 | DeliveryZone, Courier (internal/external/service, employee FK), Delivery (OneToOne Order, statuses: pending→delivered/failed/cancelled) | Нет валидации cross-org на order FK |
| `delivery/views.py` | 33 | 3 ViewSets с tenant filtering | Нет select_related → N+1 |
| `delivery/serializers.py` | 29 | 3 serializers (`fields='__all__'`) | — |
| `delivery/urls.py` | 11 | zones, couriers, deliveries | — |

### apps/finance/

| Файл | Строк | Описание | Проблемы |
|------|-------|----------|----------|
| `finance/models.py` | 165 | Wallet (cash/bank/card/online, balance, allow_negative), TransactionCategory (hierarchical), Transaction (6 типов, wallet_from/wallet_to), Debt (we_owe/owed_to_us, `@property remaining`) | — |
| `finance/views.py` | 66 | 4 ViewSets: Wallet (с `summary` action), TransactionCategory, Transaction, Debt | **P0:** Transaction создаётся без обновления Wallet.balance. Нет select_related → N+1 |
| `finance/serializers.py` | 42 | 4 serializers | — |
| `finance/urls.py` | 12 | wallets, categories, transactions, debts | — |

### apps/inventory/

| Файл | Строк | Описание | Проблемы |
|------|-------|----------|----------|
| `inventory/models.py` | 211 | Batch (FIFO remaining), StockBalance (denormalized), StockMovement (7 типов), InventoryDocument + InventoryItem, Reserve | — |
| `inventory/views.py` | 323 | 5 ViewSets: Batch (custom create), StockBalance (ReadOnly), StockMovement (write-off, transfer, assemble/disassemble actions), InventoryDoc, Reserve | **P1:** StockMovement — полный ModelViewSet (позволяет обходить FIFO). InventoryDoc и Reserve не используются фронтендом |
| `inventory/serializers.py` | 58 | 6 serializers с nested InventoryItemSerializer | — |
| `inventory/urls.py` | 13 | batches, stock, movements, inventory-docs, reserves | — |
| `inventory/services.py` | 518 | **CRITICAL бизнес-логика:** fifo_write_off, process_batch_receipt, process_sale_items, assemble_bouquet, disassemble_bouquet, write_off_stock, transfer_stock. Все в @transaction.atomic | **P1:** assemble_bouquet считает себестоимость из avg_price после списания. `_update_stock_balance` clamp к 0 вместо ошибки |

### apps/marketing/

| Файл | Строк | Описание | Проблемы |
|------|-------|----------|----------|
| `marketing/models.py` | 149 | AdChannel, AdInvestment, Discount (percent/fixed, apply_to: all/group/nomenclature), PromoCode (max_uses, used_count), LoyaltyProgram (bonus/discount/cashback) | PromoCode.used_count не инкрементируется. LoyaltyProgram — только CRUD |
| `marketing/views.py` | 47 | 5 ViewSets | Нет бизнес-логики |
| `marketing/serializers.py` | 42 | 5 serializers | — |
| `marketing/urls.py` | 14 | channels, investments, discounts, promo-codes, loyalty | — |

### apps/nomenclature/

| Файл | Строк | Описание | Проблемы |
|------|-------|----------|----------|
| `nomenclature/models.py` | 168 | NomenclatureGroup (hierarchical), MeasureUnit (**БЕЗ org FK**), Nomenclature (12 типов: single_flower, bouquet, composition, ..., prices, season, shelf_life, min_stock), BouquetTemplate (OneToOne Nomenclature), BouquetComponent (template, nomenclature, qty, substitute) | **P1:** MeasureUnit без organization — cross-tenant exposure. Нет ImageField для фото |
| `nomenclature/views.py` | 64 | 5 ViewSets: NomenclatureGroup, MeasureUnit (**БЕЗ tenant filter**), Nomenclature, BouquetTemplate, BouquetComponent | **P1:** MeasureUnitViewSet без изоляции |
| `nomenclature/serializers.py` | 64 | Recursive NomenclatureGroupSerializer (children), NomenclatureSerializer (nested bouquet_template), NomenclatureListSerializer | — |
| `nomenclature/urls.py` | 13 | groups, units, items, bouquet-templates, bouquet-components | — |

### apps/sales/

| Файл | Строк | Описание | Проблемы |
|------|-------|----------|----------|
| `sales/models.py` | 208 | Sale (open/completed/cancelled, TradingPoint/Customer/User/Order/PaymentMethod FKs), SaleItem (batch FK, cost_price, is_custom_bouquet), Order (8 статусов, 7 источников, delivery info, promo_code), OrderItem, OrderStatusHistory | **P1:** Sale.number и Order.number — нет unique/autogenerate. Sale.total не пересчитывается |
| `sales/views.py` | 70 | 4 ViewSets: Sale, SaleItem, Order, OrderItem | **P0:** Нет вызова process_sale_items(). Нет writable nested items |
| `sales/serializers.py` | 73 | Sale/Order serializers с nested items (read_only!) и status_history | **P0:** `items = SaleItemSerializer(many=True, read_only=True)` — фронт шлёт, бэк игнорирует |
| `sales/urls.py` | 12 | sales, sale-items, orders, order-items | — |

### apps/staff/

| Файл | Строк | Описание | Проблемы |
|------|-------|----------|----------|
| `staff/models.py` | 172 | Position, Employee (User FK, TradingPoint FK), PayrollScheme (5 типов — **мёртвый код**), Shift, SalaryAccrual (pending/approved/paid) | PayrollScheme: нет serializer, нет ViewSet, нет URL |
| `staff/views.py` | 61 | 5 ViewSets: Position, Employee, PayrollScheme (пустой?), Shift, SalaryAccrual | Нет валидации пересечения смен |
| `staff/serializers.py` | 45 | 5 serializers | — |
| `staff/urls.py` | 13 | positions, employees, payroll-schemes, shifts, salary-accruals | payroll-schemes маршрут зарегистрирован, но фронтенд его не использует |

### apps/suppliers/

| Файл | Строк | Описание | Проблемы |
|------|-------|----------|----------|
| `suppliers/models.py` | 166 | Supplier, SupplierNomenclature (price per supplier+item), SupplierOrder (6 статусов, nested items), SupplierOrderItem, Claim (status, photos JSONField) | При статусе `received` не создаётся приход на склад |
| `suppliers/views.py` | 53 | 4 ViewSets | Нет writable nested items для SupplierOrder. Нет cross-org validation |
| `suppliers/serializers.py` | 45 | 5 serializers (вкл. SupplierOrderItemSerializer) | items read_only |
| `suppliers/urls.py` | 12 | suppliers, nomenclatures, orders, claims | — |

---

## Приложение B — Инвентарь файлов фронтенда

### Инфраструктура

| Файл | Строк | Описание | Проблемы |
|------|-------|----------|----------|
| `src/api.ts` | 42 | Axios instance, JWT Bearer injection, 401 auto-refresh с redirect на /login | Токены в localStorage (XSS). Нет типизации ответов |
| `src/App.tsx` | 58 | React Router: 15 маршрутов с PrivateRoute | — |
| `src/main.tsx` | 20 | React 18 createRoot, BrowserRouter, ThemeProvider | — |
| `src/theme.ts` | 53 | MUI theme: pink primary (#E91E63), purple secondary, Inter font, rounded shapes | — |
| `src/contexts/AuthContext.tsx` | 88 | User interface, login/logout/refreshUser/switchOrganization | Нет типа для JWT payload |
| `src/contexts/NotificationContext.tsx` | 42 | Snackbar-based notifications (success/error/warning/info) | — |

### Компоненты

| Файл | Строк | Описание | Проблемы |
|------|-------|----------|----------|
| `src/components/Layout.tsx` | ~250 | Collapsible sidebar (14 items, admin superuserOnly), AppBar с org switcher, onboarding alert | — |
| `src/components/DataTable.tsx` | 100 | Generic table: search, pagination, skeleton, row click | Не дженерик (нет `<T>`), column render принимает `any` |
| `src/components/EntityFormDialog.tsx` | 50 | Generic modal dialog с submit/cancel | — |
| `src/components/ConfirmDialog.tsx` | 37 | Confirmation dialog | — |

### Утилиты

| Файл | Строк | Описание | Проблемы |
|------|-------|----------|----------|
| `src/utils/extractError.ts` | 133 | DRF error parser с Russian field labels (50+ маппингов), flattenValue для nested errors | Хорошо реализован, покрывает основные кейсы |

### Страницы

| Файл | Строк | Описание | Проблемы |
|------|-------|----------|----------|
| `LoginPage.tsx` | 103 | Login form (username + password), demo credentials hint | — |
| `DashboardPage.tsx` | 347 | 5 KPI cards (revenue, sales, month, orders, wallet balance), 2 recharts (area/bar), low stock list, recent sales | Low stock не фильтрует по min_stock. Wallet balance — отдельный запрос |
| `NomenclaturePage.tsx` | 672 | 4 tabs: Nomenclature CRUD, Groups, Units, Bouquet Templates + Components | Компоненты шаблона удаляются/пересоздаются при сохранении (не атомарно) |
| `InventoryPage.tsx` | 646 | 3 tabs: Stock balances (RO), Batches (CRUD), Movements (list + write-off/transfer/assemble/disassemble dialogs) | Batch form позволяет менять remaining напрямую |
| `SalesPage.tsx` | 518 | Sales list + filters, create/edit with line items, detail dialog | **P0:** items отправляются но не сохраняются на backend |
| `OrdersPage.tsx` | 760 | Orders CRUD, 8 status flow, items, delivery fields, status history timeline | **P0:** items не сохраняются. Нет редактирования позиций после создания |
| `CustomersPage.tsx` | 537 | 2 tabs: Customers CRUD (with detail: dates + addresses), Groups | ~25 useState-переменных |
| `SuppliersPage.tsx` | 590 | 4 tabs: Suppliers, Orders (+items), Nomenclature, Claims | items заказа не сохраняются на backend |
| `StaffPage.tsx` | 646 | 4 tabs: Employees, Positions, Shifts, Salary Accruals | Нет PayrollScheme tab (мёртвая модель). ~36 useState |
| `FinancePage.tsx` | 537 | 4 tabs: Wallets (+ summary), Transactions, Categories, Debts | Транзакции не обновляют Wallet.balance |
| `MarketingPage.tsx` | 500 | 5 tabs: Ad Channels, Investments, Discounts, Promo Codes, Loyalty Programs | Всё — чистый CRUD, нет бизнес-логики |
| `DeliveryPage.tsx` | 500 | 3 tabs: Deliveries, Couriers, Zones | Order — текстовое поле UUID вместо select. Courier.employee не привязывается |
| `AnalyticsPage.tsx` | 322 | Summary cards, LineChart + BarChart (recharts), DailySummary table | Нет формы создания сводки. Нет экспорта данных |
| `SettingsPage.tsx` | 524 | 5 tabs: Organization, Trading Points, Warehouses, Payment Methods, Users (RBAC-gated) | Owner/Admin access check только на фронтенде (бэкенд не проверяет) |
| `AdminPage.tsx` | 258 | Superadmin panel: Organizations CRUD с billing (plans, paid_until, max_users) | Каскадное удаление организации без soft-delete |
| `ProfilePage.tsx` | 228 | Profile edit (name, email, phone) + password change | — |

---

## Итоговая сводка

| Категория | Кол-во | P0 | P1 | P2 | P3 |
|-----------|--------|----|----|----|----|
| Критические баги | 5 | 3 | 2 | — | — |
| Безопасность | 9 | 2 | 4 | 3 | — |
| Отсутствующий функционал | 12 | — | 3 | 6 | 3 |
| UX / Фронтенд | 9 | — | 2 | 4 | 3 |
| Архитектура бэкенда | 8 | — | 2 | 4 | 2 |
| Целостность данных | 8 | — | 3 | 3 | 2 |
| Мультитенантность | 5 | — | 2 | 2 | 1 |
| TypeScript | 5 | — | — | 3 | 2 |
| Мёртвый код | 8 | — | — | 2 | 6 |
| Цветочный бизнес | 10 | — | 3 | 4 | 3 |
| **Итого** | **79** | **5** | **21** | **31** | **22** |
